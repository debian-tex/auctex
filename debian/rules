#! /usr/bin/make -f
#
# BEWARE: The rules file is AUTOMATICALLY GENERATED from rules.in
#
# rules file for Debian auctex package.
# $Id: rules,v 1.57 2005/02/05 02:40:35 salve Exp $
#
# Copyright (C) 1997, 98, 99, 2000, 01, 02, 03, 04 by Davide Giovanni
# Maria Salvetti.
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to: The Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
#
# On Debian GNU/Linux System you can find a copy of the GNU General Public
# License in "/usr/share/common-licenses/GPL".

tmp	:= $(shell pwd)/debian/tmp/

SHELL		:= /bin/bash
INSTDIR		:= install -m 755 -d
INSTPROG	:= install -m 755 -s
INSTDATA	:= install -m 644
INSTSCRIPT	:= install -m 755

DFILES	:=	debian/README debian/conffiles debian/config debian/copyright \
		debian/cron debian/docbase debian/install debian/preinst \
		debian/postinst debian/prerm debian/postrm debian/remove \
		debian/templates \
		debian/update-auctex-elisp debian/update-auctex-elisp.8 \
		debian/update-auctex-install debian/update-auctex-install.8
# WARNING: The man pages should be manually fixed in case of ${UPDATE_ELISP}
# and ${UPDATE_INSTALL} variations.
# WARNING: debian/rules SHOULD NOT be in $(DFILES), for Debian policy
# (it's CVS registered), lest it will be deleted by clean.
# Beside, it's automatically remade by make

AUCTEXSCRIPTS	:= configure install-sh
AUCTEXSRC	:= $(shell ls *.in | grep -v configure) *.el
AUCTEXSTYLES	:= style/*.el style/.nosearch
# Hack needed by configure: touch Makefile.in in auctexdoc.
auctexdoc	:= $(tmp)//usr/share/emacs/site-lisp/auctex//doc
AUCTEXDOC	:= Makefile.in

debian/system.variables: /home/salve/.../Debian/Packages/system.variables
	$(INSTDATA) $< $@

debian/rules: debian/variables

# Eperl is simply great: thanks, Ralf!
% :: %.in
	eperl -P -o $@ $<

build: $(DFILES)
	$(checkdir)
	test -x ./autogen.sh && ./autogen.sh || true
	./configure --infodir=/usr/share/info/
	cd doc && $(MAKE) auctex.info
	cd doc && $(MAKE) html/auctex_toc.html
	cd doc && $(MAKE) README CHANGES FAQ HISTORY
	touch build

clean:
	$(checkdir)
	-rm -rf build core $(tmp) debian/{files*,substvars}
	-$(MAKE) distclean
	-rm -f $(DFILES)

binary: binary-indep binary-arch

binary-arch: checkroot build
	$(checkdir)

binary-indep: checkroot build
	$(checkdir)
	-rm -rf $(tmp)

# install package
	$(INSTDIR) $(tmp)//usr/share/emacs/site-lisp/auctex/ $(tmp)//usr/share/emacs/site-lisp/auctex//style/ $(auctexdoc)
	$(INSTSCRIPT) $(AUCTEXSCRIPTS) $(tmp)//usr/share/emacs/site-lisp/auctex//
	$(INSTDATA) $(AUCTEXSRC) $(tmp)//usr/share/emacs/site-lisp/auctex//
	$(INSTDATA) $(AUCTEXSTYLES) $(tmp)//usr/share/emacs/site-lisp/auctex//style//
	umask 0022; echo -e "clean distclean:\n\trm -f Makefile\n" \
		> $(auctexdoc)/$(AUCTEXDOC)
	$(INSTDIR) $(tmp)//usr/share/info/
	umask 0022; echo -e "\nFile: dir\tNode: Top\tTop\n" \
		> $(tmp)//usr/share/info//dir
	cd doc && $(MAKE) install infodir=$(tmp)//usr/share/info/ \
		&& rm $(tmp)//usr/share/info//dir{,.old}
	gzip -9frv $(tmp)//usr/share/info/

# install Debian doc
	$(INSTDIR) $(tmp)//usr/share/doc/auctex/ $(tmp)//usr/share/doc/auctex//src/ \
		$(tmp)//usr/share/doc/auctex//HTML $(tmp)//usr/share/man//man8/
	$(INSTDATA) doc/README doc/CHANGES doc/FAQ doc/HISTORY  \
		$(tmp)//usr/share/doc/auctex/
	$(INSTDATA) doc/*.tex{,i} $(tmp)//usr/share/doc/auctex//src/
	$(INSTDATA) debian/README $(tmp)//usr/share/doc/auctex//README.Debian
	$(INSTDATA) ChangeLog $(tmp)//usr/share/doc/auctex/
	$(INSTDATA) RELEASE $(tmp)//usr/share/doc/auctex/
	$(INSTDATA) debian/changelog $(tmp)//usr/share/doc/auctex//changelog.Debian
	gzip -9frv $(tmp)//usr/share/doc/auctex/
	ln -sf ChangeLog.gz $(tmp)//usr/share/doc/auctex//changelog.gz
	$(INSTDATA) debian/copyright $(tmp)//usr/share/doc/auctex/
	$(INSTDATA) doc/html/*.html $(tmp)//usr/share/doc/auctex//HTML
	ln -snf auctex.html $(tmp)//usr/share/doc/auctex//HTML/index.html
	$(INSTDATA) debian/update-auctex-elisp.8 $(tmp)//usr/share/man//man8/
	$(INSTDATA) debian/update-auctex-install.8 $(tmp)//usr/share/man//man8/
	gzip -9frv $(tmp)//usr/share/man/

# install Debian system files
	$(INSTDIR) $(tmp)//usr/share/emacs/site-lisp/auctex/ $(tmp)//etc/cron.weekly/ \
		$(tmp)//usr/sbin/ $(tmp)//usr/lib/emacsen-common/packages//{install,remove} \
		$(tmp)//usr/share/doc-base/ $(tmp)//var/lib/auctex/
	$(INSTDATA) debian/docbase $(tmp)//usr/share/doc-base//auctex
	$(INSTSCRIPT) debian/cron $(tmp)//etc/cron.weekly//auctex
	$(INSTSCRIPT) debian/update-auctex-elisp $(tmp)//usr/sbin/
	$(INSTSCRIPT) debian/update-auctex-install $(tmp)//usr/sbin/
	$(INSTSCRIPT) debian/install $(tmp)//usr/lib/emacsen-common/packages//install/auctex
	$(INSTSCRIPT) debian/remove $(tmp)//usr/lib/emacsen-common/packages//remove/auctex

# install Debian control files
	$(INSTDIR) $(tmp)//DEBIAN/
	$(INSTDATA) debian/{conffiles,templates} $(tmp)//DEBIAN/
	$(INSTSCRIPT) debian/{config,preinst,postinst,postrm,prerm} \
		$(tmp)//DEBIAN/

# standard stuff
#-#	cd $(tmp) && du -k * | grep -v 'DEBIAN' | sort -k 2 -o $(tmp)//DEBIAN//du
	cd $(tmp) && md5sum \
		$$(find ./ -path './DEBIAN' -prune -o -type f -printf "%P\n") \
		| sort -k 2 -o $(tmp)//DEBIAN//md5sums
	dpkg-gencontrol -isp
	chown -R root.root $(tmp)
	chmod -R go=rX $(tmp)
	dpkg --build $(tmp) ..

checkdir = test -f debian/rules

checkroot:
	$(checkdir)
	test root = "$$(whoami)"

source diff:
	@echo >&2 'source and diff are obsolete - use dpkg-source -b'; false

.PHONY: binary binary-arch binary-indep clean checkroot
