#include "variables"
#! /usr/bin/make -f
#
# rules for <:=${PACKAGE}:>
#
<:=@COPYRIGHT:>//

tmp := $(shell pwd)/debian/tmp/

SHELL := /bin/bash
INSTDIR := install -m 755 -d
INSTPROG := install -m 755 -s
INSTDATA := install -m 644
INSTSCRIPT := install -m 755
STRIP := strip -R .note -R .comment

<:# DO NOT include <% debian/rules %> :>//
DFILES := debian/README debian/copyright \
debian/config debian/postinst debian/prerm debian/postrm \
debian/conffiles debian/cron debian/docbase debian/templates \
debian/bug.presubj debian/bug.script \
debian/install debian/remove \
debian/<:=${UPDATE_ELISP}:> debian/<:=${UPDATE_ELISP}:>.8 \
debian/<:=${UPDATE_INSTALL}:> debian/<:=${UPDATE_INSTALL}:>.8

AUCTEXSCRIPTS := configure install-sh
AUCTEXSRC := $(shell ls *.in | grep -v configure) *.el
AUCTEXSTYLES := style/*.el style/.nosearch
<:# Hack needed by configure: touch Makefile.in in auctexdoc. :>//
auctexdoc := $(tmp)/<:=${lisp}:>/doc
AUCTEXDOC := Makefile.in

.PHONY: pre-build
pre-build:
	test -x ./autogen.sh && ./autogen.sh || true

debian/rules: debian/variables

<:# Eperl is simply great: thanks, Ralf! :>//
% :: %.in
	eperl -P -o $@ $<

build: checkdir $(DFILES)
	./configure --infodir=<:=${info}:>
	cd doc && $(MAKE) auctex.info
	cd doc && $(MAKE) html/auctex_toc.html
	cd doc && $(MAKE) <:=${DOCS}:>
	touch build

.PHONY: clean
clean: checkdir
	-rm -rf build core $(tmp) debian/{files*,substvars}
	-$(MAKE) distclean
	-rm -f $(DFILES)

.PHONY: binary
binary: binary-arch binary-indep

.PHONY: binary-indep
binary-indep: checkdir checkroot build
	-rm -rf $(tmp)

<:# install package :>//
	$(INSTDIR) $(tmp)/<:=${lisp}:> $(tmp)/<:=${style}:> $(auctexdoc)
	$(INSTSCRIPT) $(AUCTEXSCRIPTS) $(tmp)/<:=${lisp}:>/
	$(INSTDATA) $(AUCTEXSRC) $(tmp)/<:=${lisp}:>/
#       "tex-site.el" should not be installed
	rm -f $(tmp)/<:=${lisp}:>/tex-site.el
	$(INSTDATA) $(AUCTEXSTYLES) $(tmp)/<:=${style}:>/
	umask 0022; echo -e "clean distclean:\n\trm -f Makefile\n" \
		> $(auctexdoc)/$(AUCTEXDOC)
	$(INSTDIR) $(tmp)/<:=${info}:>
	umask 0022; echo -e "\nFile: dir\tNode: Top\tTop\n" \
		> $(tmp)/<:=${info}:>/dir
	cd doc && $(MAKE) install infodir=$(tmp)/<:=${info}:> \
		&& rm $(tmp)/<:=${info}:>/dir{,.old}
	gzip -9frv $(tmp)/<:=${info}:>

<:# install Debian doc :>//
	$(INSTDIR) $(tmp)/<:=${doc}:> $(tmp)/<:=${docsrc}:> \
		$(tmp)/<:=${html}:> $(tmp)/<:=${man}:>/man8/
	$(INSTDATA) <:for (split (/ /, ${DOCS})) { print "doc/$_ "; }:> \
		$(tmp)/<:=${doc}:>
	$(INSTDATA) doc/*.tex{,i} $(tmp)/<:=${docsrc}:>
	$(INSTDATA) debian/README $(tmp)/<:=${doc}:>/README.Debian
	$(INSTDATA) ChangeLog $(tmp)/<:=${doc}:>
	$(INSTDATA) RELEASE $(tmp)/<:=${doc}:>
	$(INSTDATA) debian/changelog $(tmp)/<:=${doc}:>/changelog.Debian
	gzip -9frv $(tmp)/<:=${doc}:>
	ln -sf ChangeLog.gz $(tmp)/<:=${doc}:>/changelog.gz
	$(INSTDATA) debian/copyright $(tmp)/<:=${doc}:>
	$(INSTDATA) doc/html/*.html $(tmp)/<:=${html}:>
	ln -snf auctex.html $(tmp)/<:=${html}:>/index.html
	$(INSTDATA) debian/<:=${UPDATE_ELISP}:>.8 $(tmp)/<:=${man}:>/man8/
	$(INSTDATA) debian/<:=${UPDATE_INSTALL}:>.8 $(tmp)/<:=${man}:>/man8/
	gzip -9frv $(tmp)/<:=${man}:>

<:# install Debian system files :>//
	$(INSTDIR) $(tmp)/<:=${cron_weekly}:>
	$(INSTSCRIPT) debian/cron $(tmp)/<:=${cron_weekly}:>/<:=${PACKAGE}:>
	$(INSTDIR) $(tmp)/<:=${sbin}:>
	$(INSTSCRIPT) debian/<:=${UPDATE_ELISP}:> $(tmp)/<:=${sbin}:>
	$(INSTSCRIPT) debian/<:=${UPDATE_INSTALL}:> $(tmp)/<:=${sbin}:>
	$(INSTDIR) $(tmp)/<:=${var}:>
	$(INSTDIR) $(tmp)/<:=${lisp}:>
	$(INSTDIR) $(tmp)/<:=${ecode}:>/{install,remove}
	$(INSTSCRIPT) debian/install \
		$(tmp)/<:=${ecode}:>/install/<:=${PACKAGE}:>
	$(INSTSCRIPT) debian/remove \
		$(tmp)/<:=${ecode}:>/remove/<:=${PACKAGE}:>
	$(INSTDIR) $(tmp)/<:=${docbase}:>
	$(INSTDATA) debian/docbase $(tmp)/<:=${docbase}:>/<:=${PACKAGE}:>
	$(INSTDIR) $(tmp)/<:=${bug}:>
	$(INSTDATA) debian/bug.presubj $(tmp)/<:=${bug}:>/presubj
	$(INSTSCRIPT) debian/bug.script $(tmp)/<:=${bug}:>/script

<:# install Debian control files :>//
	$(INSTDIR) $(tmp)/<:=${debian}:>
	$(INSTDATA) debian/{conffiles,templates} $(tmp)/<:=${debian}:>
	$(INSTSCRIPT) debian/{config,postinst,postrm,prerm} \
		$(tmp)/<:=${debian}:>

<:# standard stuff :>//
	cd $(tmp) && md5sum \
		$$(find ./ -path './DEBIAN' -prune \
		-o -type f -printf "%P\n") \
		| sort -k 2 -o $(tmp)/<:=${debian}:>/md5sums
	dpkg-gencontrol -isp
	chown -R root.root $(tmp)
	chmod -R go=rX $(tmp)
	dpkg --build $(tmp) ..

.PHONY: binary-arch
binary-arch: checkroot build
	$(checkdir)

.PHONY: checkdir
checkdir:
	test -f debian/rules

.PHONY: checkroot
checkroot:
	test root = "$$(whoami)"

.PHONY: build-package
build-package:
	dpkg-buildpackage -rfakeroot -tc -i

.PHONY: source diff
source diff:
	@echo >&2 'source and diff are obsolete - use dpkg-source -b'; false

<:
# LocalWords:  Eperl Ralf auctexdoc tex
# local variables:
# mode: makefile
# ispell-local-dictionary: "american"
# ispell-check-comments: exclusive
# end:
:>//
# arch-tag: 7f6799c7-dca1-4d84-8038-1ad9c2888751<:='-child':>
